
# セントラルサーバプライベートIPからアクセスできない問題調査

## 0.

* BIC-cesl-all (繋がらない1)
* BIC-CESLMGR01-EC2(繋がらない2)
* BIC-CESLMGR12701-EC2  (繋がる方)


## 1.現状確認

### BIC-cesl-all (繋がらない1)

#### プライベートIP

ping
```
C:\Users\ps0095>ping 10.194.8.236

10.194.8.236 に ping を送信しています 32 バイトのデータ:
要求がタイムアウトしました。
要求がタイムアウトしました。
要求がタイムアウトしました。
要求がタイムアウトしました。

10.194.8.236 の ping 統計:
    パケット数: 送信 = 4、受信 = 0、損失 = 4 (100% の損失)、
```

tracert
```
C:\Users\ps0095>tracert 10.194.8.236

10.194.8.236 へのルートをトレースしています。経由するホップ数は最大 30 です

  1     1 ms    <1 ms    <1 ms  192.168.2.1
  2     *        *        *     要求がタイムアウトしました。
  3     *        *        *     要求がタイムアウトしました。
  4     *        *        *     要求がタイムアウトしました。
  5     *        *        *     要求がタイムアウトしました。
  6     *        *        *     要求がタイムアウトしました。
  7     *        *        *     要求がタイムアウトしました。
  8     *        *        *     要求がタイムアウトしました。
  9     *        *        *     要求がタイムアウトしました。
```

ssh
> ホストに接続できません

#### パブリックIP

ping
```
C:\Users\ps0095>ping 18.176.174.24

18.176.174.24 に ping を送信しています 32 バイトのデータ:
要求がタイムアウトしました。
要求がタイムアウトしました。
要求がタイムアウトしました。
要求がタイムアウトしました。

18.176.174.24 の ping 統計:
    パケット数: 送信 = 4、受信 = 0、損失 = 4 (100% の損失)、
```

tracert
```
C:\Users\ps0095>tracert 18.176.174.24

ec2-18-176-174-24.ap-northeast-1.compute.amazonaws.com [18.176.174.24] へのルートをトレースしています
経由するホップ数は最大 30 です:

  1     1 ms     1 ms    <1 ms  192.168.2.1
  2     4 ms     3 ms     3 ms  153.153.217.241
  3     3 ms     2 ms     3 ms  153.153.217.129
  4     6 ms     5 ms     5 ms  153.153.223.133
  5    22 ms    18 ms    18 ms  180.8.126.45
  6     5 ms     7 ms     5 ms  122.1.245.213
  7    36 ms    39 ms    35 ms  ae-6.r03.tokyjp05.jp.bb.gin.ntt.net [120.88.53.29]
  8    43 ms    38 ms    32 ms  ae-1.a01.tokyjp06.jp.bb.gin.ntt.net [129.250.5.150]
  9    28 ms    31 ms    35 ms  ae-0.amazon.tokyjp06.jp.bb.gin.ntt.net [203.105.73.46]
 10     *        *        *     要求がタイムアウトしました。
 11     *        *        *     要求がタイムアウトしました。
 12    16 ms    24 ms    18 ms  54.239.52.85
 13    21 ms    22 ms    25 ms  52.95.30.62
 14     *        *        *     要求がタイムアウトしました。
 15     *        *        *     要求がタイムアウトしました。
 16     *        *        *     要求がタイムアウトしました。
 17    37 ms    39 ms    31 ms  52.95.31.53
 18    14 ms    14 ms    14 ms  52.95.31.187
 19    16 ms    16 ms    14 ms  52.95.31.186
 20    15 ms    15 ms    15 ms  52.95.31.132
 21    19 ms    19 ms    16 ms  52.95.30.220
 22     *        *        *     要求がタイムアウトしました。
 23     *        *        *     要求がタイムアウトしました。
 24     *        *        *     要求がタイムアウトしました。
 25     *        *        *     要求がタイムアウトしました。
 26     *        *        *     要求がタイムアウトしました。
 27     *        *        *     要求がタイムアウトしました。
 28     *        *        *     要求がタイムアウトしました。
 29     *        *        *     要求がタイムアウトしました。
 30     *        *        *     要求がタイムアウトしました。

トレースを完了しました。
```

ssh
> ホストに接続できません

### BIC-CESLMGR01-EC2(繋がらない2)

#### プライベートIP

ping
```
C:\Users\ps0095>ping 10.194.8.7

10.194.8.7 に ping を送信しています 32 バイトのデータ:
10.194.8.7 からの応答: バイト数 =32 時間 =34ms TTL=61
10.194.8.7 からの応答: バイト数 =32 時間 =25ms TTL=61
10.194.8.7 からの応答: バイト数 =32 時間 =33ms TTL=61
10.194.8.7 からの応答: バイト数 =32 時間 =51ms TTL=61

10.194.8.7 の ping 統計:
    パケット数: 送信 = 4、受信 = 4、損失 = 0 (0% の損失)、
ラウンド トリップの概算時間 (ミリ秒):
    最小 = 25ms、最大 = 51ms、平均 = 35ms
```

tracert
```
C:\Users\ps0095>tracert 10.194.8.7

10.194.8.7 へのルートをトレースしています。経由するホップ数は最大 30 です

  1     1 ms    <1 ms    <1 ms  192.168.2.1
  2     *        *        *     要求がタイムアウトしました。
  3    47 ms    43 ms    37 ms  10.194.8.7

トレースを完了しました。

```

ssh
> ホストに接続できません



###  BIC-CESLMGR12701-EC2  (繋がる方)

#### プライベートIP

ping
```
C:\Users\ps0095>ping 10.194.8.205

10.194.8.205 に ping を送信しています 32 バイトのデータ:
10.194.8.205 からの応答: バイト数 =32 時間 =18ms TTL=61
10.194.8.205 からの応答: バイト数 =32 時間 =18ms TTL=61
10.194.8.205 からの応答: バイト数 =32 時間 =16ms TTL=61
10.194.8.205 からの応答: バイト数 =32 時間 =17ms TTL=61

10.194.8.205 の ping 統計:
    パケット数: 送信 = 4、受信 = 4、損失 = 0 (0% の損失)、
ラウンド トリップの概算時間 (ミリ秒):
    最小 = 16ms、最大 = 18ms、平均 = 17ms
```

tracert
```
C:\Users\ps0095>tracert 10.194.8.205

10.194.8.205 へのルートをトレースしています。経由するホップ数は最大 30 です

  1     1 ms    <1 ms    <1 ms  192.168.2.1
  2     *        *        *     要求がタイムアウトしました。
  3    26 ms    24 ms    23 ms  10.194.8.205

トレースを完了しました。
```


## 2.セキュリティグループの確認

同じ
> CESLMGR127-SG   

## 3. サブネットとルートテーブル

### BIC-cesl-all (繋がらない1)

> subnet-0e93ef737278cec2d

local(10.194.8.0/24)のみ

* ルートテーブルと明示的に関連付けられていない
* ルートが不足している

###  BIC-CESLMGR12701-EC2  (繋がる+繋がらない2)

> subnet-004d2924b9231193d

* local(10.194.8.0/24)
* tgw-0fa25a252dc6cec7e(192.168.2.0/24)
* igw-0f0337e6b0f0c7982(0.0.0.0/0)
* vpce-0f662074eedc20e64(pl-61a54008)


### 繋がらない1 関連付け＋ルートテーブルにルート追加してみた

#### プライベートIP

ping
```
C:\Users\ps0095>ping 10.194.8.236

10.194.8.236 に ping を送信しています 32 バイトのデータ:
10.194.8.236 からの応答: バイト数 =32 時間 =16ms TTL=61
10.194.8.236 からの応答: バイト数 =32 時間 =31ms TTL=61
10.194.8.236 からの応答: バイト数 =32 時間 =20ms TTL=61
10.194.8.236 からの応答: バイト数 =32 時間 =23ms TTL=61

10.194.8.236 の ping 統計:
    パケット数: 送信 = 4、受信 = 4、損失 = 0 (0% の損失)、
ラウンド トリップの概算時間 (ミリ秒):
    最小 = 16ms、最大 = 31ms、平均 = 22ms
```

tracert 
```
C:\Users\ps0095>tracert 10.194.8.236

10.194.8.236 へのルートをトレースしています。経由するホップ数は最大 30 です

  1     2 ms     3 ms     2 ms  192.168.2.1
  2     *        *        *     要求がタイムアウトしました。
  3    16 ms    15 ms    19 ms  10.194.8.236

トレースを完了しました。
```

ssh
> ホストに接続できません


#### パブリックIP

ping
```
C:\Users\ps0095>ping 18.176.174.24

18.176.174.24 に ping を送信しています 32 バイトのデータ:
18.176.174.24 からの応答: バイト数 =32 時間 =15ms TTL=37
18.176.174.24 からの応答: バイト数 =32 時間 =15ms TTL=37
18.176.174.24 からの応答: バイト数 =32 時間 =15ms TTL=37
18.176.174.24 からの応答: バイト数 =32 時間 =15ms TTL=37

18.176.174.24 の ping 統計:
    パケット数: 送信 = 4、受信 = 4、損失 = 0 (0% の損失)、
ラウンド トリップの概算時間 (ミリ秒):
    最小 = 15ms、最大 = 15ms、平均 = 15ms
```

tracert
```
C:\Users\ps0095>tracert 18.176.174.24

ec2-18-176-174-24.ap-northeast-1.compute.amazonaws.com [18.176.174.24] へのルートをトレースしています
経由するホップ数は最大 30 です:

  1     1 ms     1 ms    <1 ms  192.168.2.1
  2    13 ms    12 ms     8 ms  153.153.217.241
  3    23 ms    20 ms    23 ms  153.153.217.129
  4    12 ms    13 ms    13 ms  153.153.223.133
  5    13 ms    10 ms    16 ms  180.8.126.45
  6     9 ms     8 ms     6 ms  122.1.245.213
  7    20 ms    19 ms    17 ms  ae-6.r03.tokyjp05.jp.bb.gin.ntt.net [120.88.53.29]
  8    14 ms    14 ms    14 ms  ae-1.a01.tokyjp06.jp.bb.gin.ntt.net [129.250.5.150]
  9    15 ms    17 ms    20 ms  ae-0.amazon.tokyjp06.jp.bb.gin.ntt.net [203.105.73.46]
 10     *        *        *     要求がタイムアウトしました。
 11     *        *        *     要求がタイムアウトしました。
 12    20 ms    16 ms    20 ms  54.239.52.85
 13    19 ms    18 ms    20 ms  52.95.30.62
 14     *        *        *     要求がタイムアウトしました。
 15     *        *        *     要求がタイムアウトしました。
 16     *        *        *     要求がタイムアウトしました。
 17    38 ms    41 ms    44 ms  52.95.31.37
 18    18 ms    17 ms    19 ms  52.95.31.219
 19    26 ms    27 ms    33 ms  52.95.31.214
 20    34 ms    38 ms    43 ms  52.95.31.128
 21    32 ms    32 ms    30 ms  52.95.30.220
 22     *        *        *     要求がタイムアウトしました。
 23     *        *        *     要求がタイムアウトしました。
 24     *        *        *     要求がタイムアウトしました。
 25     *        *        *     要求がタイムアウトしました。
 26     *        *        *     要求がタイムアウトしました。
 27    15 ms    14 ms    15 ms  ec2-18-176-174-24.ap-northeast-1.compute.amazonaws.com [18.176.174.24]

トレースを完了しました。
```

ssh 
-> ログインできた

### transit gateway attachments

VPC側のattachmentのサブネットが所沢のサブネットしか入っていない

->追加してみる
    ->できた。けど、1attachmentに同一AZのサブネットを複数は繋げられない
        ->接続する場合はattachmentを複数作るしかない
今回は他の理由もあってTransit Gatewayをやめることにした。

### TGW -> VGW

* VGW(仮想プライベートゲートウェイ)を作成

* サイト間のVPN接続の設定を変更

* サイト間のVPN接続からconfigをダウンロード

* VPNルータの設定を変更
  * Transit Gateway設定時のconfigファイルとコンペアしたら、設定箇所は同じだったので実際はしていない
  * diffがあったら変更必要

* ルートテーブルにVGWのルートを追加

## 参考

Amazon VPC のインスタンスへの接続タイムアウトエラーをトラブルシューティングする方法を教えてください。
> https://aws.amazon.com/jp/premiumsupport/knowledge-center/instance-vpc-troubleshoot/
